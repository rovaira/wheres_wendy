<div id="current_locations_page">
  <h1>Here's Wendy!</h1>

  <table>
    <tr>
      <th>Name</th>
      <th>Class Year</th>
      <th>Address</th>
      <th>Latitude</th>
      <th>Longitude</th>
    </tr>
    <% for current_location in @current_locations %>
      <tr>
        <td><%= current_location.user.first_name %> <%= current_location.user.last_name %></td>
        <td><%= current_location.user.class_year %></td>
        <td><%= current_location.address %></td>
        <td><%= current_location.latitude %></td>
        <td><%= current_location.longitude %></td>
      </tr>
    <% end %>
  </table>

  <div style='width: 800px;'>
    <div id="map" style='width: 800px; height: 400px;'></div>
  </div>
</div>

<% if current_user %>
  <div id="user_id" style="display: none"><%= current_user.id %></div>
<% end %>

<% content_for :extra_footer do %>
<script type="text/javascript">
  $(function(){

    handler = Gmaps.build('Google');
    handler.buildMap({ provider: {}, internal: {id: 'map'}}, function(){
      if(navigator.geolocation)
        navigator.geolocation.getCurrentPosition(displayOnMap);
        markers = handler.addMarkers(<%=raw @hash.to_json %>);
        handler.bounds.extendWith(markers);
        handler.fitMapToBounds();
        // handler.getMap().setZoom(4);
    });

    var userId = document.getElementById("user_id").innerHTML;

    function displayOnMap(position){
      var selfMarker = handler.addMarker({
        lat: position.coords.latitude,
        lng: position.coords.longitude
      }, { opacity: 0.3 });
      var latitude = selfMarker["serviceObject"]["position"]["k"]
      var longitude = selfMarker["serviceObject"]["position"]["D"]
      var coordinates = {
        "latitude": latitude,
        "longitude": longitude
      };
      $.ajax({
          type: "PATCH",
          url: '/current_locations/'+userId,
          dataType: "json",
          data: JSON.stringify(coordinates),
          success: function() {
            console.log("Hi!");
          }
        });
      handler.map.centerOn(selfMarker);
    };
  })
</script>
<% end %>
